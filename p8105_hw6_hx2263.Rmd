---
title: "p8105_hw6_hx2263"
author: "Tiffany Xi"
date: "11/19/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
theme_set(theme_bw() + theme(legend.position = "bottom") + theme(plot.title = element_text(hjust = 0.5)))
```

# Problem 1

### Import data

```{r data_import}
raw_homicide = read.csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")
```

### Data tidy

Create a `city_state` variable and a binary variable indicating whether the homicide is solved; omit cities as required; modifiy `victim_race` to have categories white and non-white, with white as the reference category; victim_age is numeric.

```{r}
homicide_tidy = 
  raw_homicide %>% 
  mutate(city_state = str_c(city, ", ", state)) %>% 
  mutate(status = as.numeric(disposition == "Closed by arrest")) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>%
  mutate(victim_race = ifelse(victim_race == "White", "white", "non-white"),
         victim_race = fct_relevel(victim_race, ref = "white"),
         victim_age = as.numeric(victim_age))
```

### Baltimore, MD
Use `glm` to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors

```{r}
baltimore_log = 
  homicide_tidy %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(status ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

baltimore_log %>% broom::tidy()
```

Obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing black victims to white victims keeping all other variables fixed.

```{r}
baltimore_OR_CI = 
  baltimore_log %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         conf_lower = exp(estimate - 1.96 * std.error),
         conf_upper = exp(estimate + 1.96 * std.error)) %>% 
  select(term, OR, conf_lower, conf_upper)
  

```

For each cities
Run glm for each cities, and extract the adjusted odds ratio (and CI) for solving homicides comparing black victims to white victims.

```{r}
eachcity_log = 
  homicide_tidy %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(status ~ victim_age + victim_sex + victim_race,
                                   data = ., family = binomial())),
         models = map(models, broom::tidy)) %>% 
  select(-data) %>% 
  unnest() %>% 
  filter(term == "victim_racenon-white") %>% 
  mutate(OR = round(exp(estimate), 3),
         conf_lower = round(exp(estimate - 1.96 * std.error), 3),
         conf_upper = round(exp(estimate + 1.96 * std.error), 3)) %>% 
  select(city_state, OR, conf_lower, conf_upper)
```



