---
title: "p8105_hw6_hx2263"
author: "Tiffany Xi"
date: "11/19/2018"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(modelr)
theme_set(theme_bw() + theme(legend.position = "bottom") + theme(plot.title = element_text(hjust = 0.5)))
```

# Problem 1

### Import data

```{r data_import}
raw_homicide = read.csv("https://raw.githubusercontent.com/washingtonpost/data-homicides/master/homicide-data.csv")
```

### Data tidy

Create a `city_state` variable and a binary variable indicating whether the homicide is solved; omit cities as required; modifiy `victim_race` to have categories white and non-white, with white as the reference category; victim_age is numeric.

```{r}
homicide_tidy = 
  raw_homicide %>% 
  mutate(city_state = str_c(city, ", ", state)) %>% 
  mutate(status = as.numeric(disposition == "Closed by arrest")) %>% 
  filter(!(city_state %in% c("Dallas, TX", "Phoenix, AZ", "Kansas City, MO", "Tulsa, AL"))) %>%
  mutate(victim_race = ifelse(victim_race == "White", "white", "non-white"),
         victim_race = fct_relevel(victim_race, ref = "white"),
         victim_age = as.numeric(victim_age))
```

### glm in Baltimore, MD
Use `glm` to fit a logistic regression with resolved vs unresolved as the outcome and victim age, sex and race as predictors

```{r}
baltimore_log = 
  homicide_tidy %>% 
  filter(city_state == "Baltimore, MD") %>% 
  glm(status ~ victim_age + victim_sex + victim_race, data = ., family = binomial())

baltimore_log %>% broom::tidy()
```

Obtain the estimate and confidence interval of the adjusted odds ratio for solving homicides comparing black victims to white victims keeping all other variables fixed.

```{r}
baltimore_OR_CI = 
  baltimore_log %>% 
  broom::tidy() %>% 
  mutate(OR = exp(estimate),
         conf_lower = exp(estimate - 1.96 * std.error),
         conf_upper = exp(estimate + 1.96 * std.error)) %>% 
  select(term, OR, conf_lower, conf_upper)
```

### glm for each cities
Run glm for each cities, and extract the adjusted odds ratio (and CI) for solving homicides comparing black victims to white victims.

```{r each_city}
eachcity_log = 
  homicide_tidy %>% 
  group_by(city_state) %>% 
  nest() %>% 
  mutate(models = map(data, ~glm(status ~ victim_age + victim_sex + victim_race,
                                   data = ., family = binomial())),
         models = map(models, broom::tidy)) %>% 
  select(-data) %>% 
  unnest() %>% 
  filter(term == "victim_racenon-white") %>% 
  mutate(OR = round(exp(estimate), 3),
         conf_lower = round(exp(estimate - 1.96 * std.error), 3),
         conf_upper = round(exp(estimate + 1.96 * std.error), 3)) %>% 
  select(city_state, OR, conf_lower, conf_upper)
```

### Visualization 

```{r plot}
eachcity_log %>%
  ggplot(aes(x = reorder(city_state, OR), y = OR)) +
  coord_flip() + 
  geom_point(size = 1.5, shape = 18, fill = "white") +
  geom_errorbar(mapping = aes(ymin = conf_lower, ymax = conf_upper)) +
  geom_hline(yintercept = 1, alpha = 0.4, color = "red") +
  labs(
        title = "Estimates OR and CIs for Each City",
        x = "City State",
        y = "Estimate Odd Ratio and CI",
        caption = "Data from the github package"
      ) +
    theme_bw() +
    theme(axis.text = element_text(size = 8))
```

# Problem 2

### Load and clean the data

```{r message = FALSE, cache = TRUE}
raw_birthweight = read_csv(file = "./data/birthweight.csv")

birthweight_tidy = 
  raw_birthweight %>% 
  janitor::clean_names() %>% 
  mutate(babysex = as.factor(babysex),
         frace = as.factor(frace),
         frace = recode_factor(frace, `1` = 'White', `2` = 'Black', 
                               `3` = 'Asian', `4` = 'Puerto Rican', 
                               `8` = 'Other', `9` = 'Unknown'),
         malform = as.factor(malform),
         mrace = as.factor(mrace),
         mrace = recode_factor(mrace, `1` = 'White', `2` = 'Black',
                               `3` = 'Asian', `4` = 'Puerto Rican',
                               `8` = 'Other')) %>% 
  select(bwt, everything()) 

# check for missing data
map(birthweight_tidy, ~sum(is.na(.)))

skimr::skim(birthweight_tidy)

birthweight_tidy %>% 
  select(-babysex, -frace, -mrace, -malform, -pnumlbw, -pnumsga, -parity) %>% 
  select(bwt, bhead, blength, delwt, fincome, gaweeks, menarche) %>% 
  plot()

birthweight_tidy %>% 
  select(bwt, mheight, momage, ppbmi, ppwt, smoken, wtgain) %>% 
  plot()

```

Propose a regression model for birthweight.

I 
```{r}
model_my = lm(bwt ~ bhead + blength + ppbmi + wtgain, data = birthweight_tidy)
summary(model_my)
```

### plot of model residuals against fitted values

```{r}
birthweight_tidy %>% 
  add_predictions(model_my) %>% 
  add_residuals(model_my) %>% 
  ggplot(aes(x = pred, y = resid)) +
  geom_point(alpha = 0.25)
```




Compare your model to two others:

One using length at birth and gestational age as predictors (main effects only)

```{r}
model_1 = lm(bwt ~ blength + gaweeks, data = birthweight_tidy)
summary(model_1)
```

One using head circumference, length, sex, and all interactions (including the three-way interaction) between these

```{r}
model_2 = lm(bwt ~ bhead + blength + babysex + bhead*blength + blength*babysex +  bhead*babysex + bhead*blength*babysex, data = birthweight_tidy)
summary(model_2)
```


cv_df = 
  cv_df %>% 
  mutate(model_my = map(train, ~lm(y ~ x, data = .x)),
         model_1  = map(train, ~mgcv::gam(y ~ s(x), data = .x)),
         model_2  = map(train, ~gam(y ~ s(x, k = 30), sp = 10e-6, data = .x))) %>% 
  mutate(rmse_lin    = map2_dbl(lin_mod, test, ~rmse(model = .x, data = .y)),
         rmse_nonlin = map2_dbl(nonlin_mod, test, ~rmse(model = .x, data = .y)),
         rmse_wiggly = map2_dbl(wiggly_mod, test, ~rmse(model = .x, data = .y))) %>% 
  select(starts_with("rmse")) %>% 
  gather(key = model, value = rmse) %>% 
  mutate(model = str_replace(model, "rmse_", ""),
         model = fct_inorder(model)) %>% 
  ggplot(aes(x = model, y = rmse)) + geom_violin()
